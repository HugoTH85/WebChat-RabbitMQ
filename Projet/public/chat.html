<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <link rel="stylesheet" href="style-chat.css">
    <script src="/socket.io/socket.io.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const socket = io();
            const urlParams = new URLSearchParams(window.location.search);
            const username = urlParams.get('username');

            // Rediriger si pas de nom d'utilisateur
            if (!username) {
                window.location.href = '/';
                return;
            }

            socket.emit('setUsername', username, (response) => {
                if (!response.success) {
                    alert(response.message);
                    window.location.href = '/';
                }
            });

            const messageForm = document.getElementById('messageForm');
            const messageInput = document.getElementById('messageInput');
            const chatWindow = document.getElementById('chatWindow');
            const fileInput = document.getElementById('fileInput');

            // Envoyer un message
            messageForm.addEventListener('submit', (event) => {
                event.preventDefault();
                const message = messageInput.value;
                socket.emit('sendMessage', message);
                messageInput.value = '';
            });

            // Afficher les messages
            socket.on('receiveMessage', (data) => {
                const { user, message, time } = data;
                chatWindow.innerHTML += `<p><strong>${time} ${user}:</strong> ${message}</p>`;
                chatWindow.scrollTop = chatWindow.scrollHeight;
            });

            // Gérer les fichiers envoyés
            fileInput.addEventListener('change', () => {
                const file = fileInput.files[0];
                if (file) {
                    const formData = new FormData();
                    formData.append('file', file);

                    fetch('/upload', {
                        method: 'POST',
                        body: formData
                    }).then(response => response.text())
                    .then(result => {
                        alert(result);
                        socket.emit('sendFile', file.name);
                    }).catch(error => console.error('Erreur:', error));
                }
            });

            // Afficher les fichiers reçus
            socket.on('fileReceived', (fileName) => {
                chatWindow.innerHTML += `<p><strong>Fichier reçu :</strong> <a href="/uploads/${fileName}" download>${fileName}</a></p>`;
            });

            // Déconnexion manuelle
            document.getElementById('logoutButton').addEventListener('click', () => {
                socket.emit('disconnectUser');
                window.location.href = '/';
            });

            // Afficher une erreur si le fichier n'est pas disponible
            socket.on('fileError', (errorMessage) => {
                alert(errorMessage);
            });
        });
    </script>
</head>
<body>
    <h1>Chat Room</h1>
    <div id="chatWindow" style="height: 300px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px;"></div>
    <form id="messageForm">
        <input type="text" id="messageInput" placeholder="Type a message" required>
        <button type="submit">Envoyer</button>
    </form>
    <input type="file" id="fileInput" style="margin-top: 20px;">
    <button id="logoutButton" style="margin-top: 20px;">Déconnexion</button>
</body>
</html>
