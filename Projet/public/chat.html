<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <link rel="stylesheet" href="style-chat.css">
    <script src="/socket.io/socket.io.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const socket = io();
            const urlParams = new URLSearchParams(window.location.search);
            const username = urlParams.get('username');

            if (!username) {
                window.location.href = '/';
                return;
            }

            socket.emit('setUsername', username, (response) => {
                if (!response.success) {
                    alert(response.message);
                    window.location.href = '/';
                }
            });

            const messageForm = document.getElementById('messageForm');
            const messageInput = document.getElementById('messageInput');
            const chatWindow = document.getElementById('chatWindow');
            const fileInput = document.getElementById('fileInput');
            const fileLabel = document.getElementById('fileLabel');  // Label pour le fichier
            const userList = document.getElementById('userList');

            // Envoyer un message
            messageForm.addEventListener('submit', (event) => {
                event.preventDefault();
                const message = messageInput.value;
                socket.emit('sendMessage', message);
                messageInput.value = '';
            });

            // Afficher les messages avec l'heure locale
            socket.on('receiveMessage', (data) => {
                const { user, message } = data;
                const now = new Date();
                const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                chatWindow.innerHTML += `<p><strong>[${time}] ${user}:</strong> ${message}</p>`;
                chatWindow.scrollTop = chatWindow.scrollHeight;
            });

            // Gérer les fichiers envoyés
            fileInput.addEventListener('change', () => {
                const file = fileInput.files[0];
                if (file) {
                    const formData = new FormData();
                    formData.append('file', file);

                    fetch('/upload', {
                        method: 'POST',
                        body: formData
                    }).then(response => response.text())
                    .then(result => {
                        alert(result);
                        socket.emit('sendFile', file.name);
                    }).catch(error => console.error('Erreur:', error));
                }
            });

            // Afficher les fichiers reçus
            socket.on('fileReceived', (fileName) => {
                chatWindow.innerHTML += `<p><strong>Fichier reçu :</strong> <a href="/uploads/${fileName}" download>${fileName}</a></p>`;
            });

            // Mettre à jour la liste des utilisateurs connectés
            socket.on('updateUserList', (users) => {
                userList.innerHTML = '';
                users.forEach(user => {
                    const li = document.createElement('li');
                    li.textContent = user;
                    userList.appendChild(li);
                });
            });

            // Déconnexion manuelle
            document.getElementById('logoutButton').addEventListener('click', () => {
                socket.emit('disconnectUser');
                window.location.href = '/';
            });

            socket.on('fileError', (errorMessage) => {
                alert(errorMessage);
            });
        });
    </script>
    <style>
        /* Disposition de la page en deux colonnes : liste des utilisateurs à gauche et chat à droite */
        .container {
            display: flex;
            flex-direction: row;
            height: 100vh;
        }

        #usersContainer {
            flex: 1;
            border: 1px solid #ccc;
            padding: 10px;
            margin-right: 20px;
            overflow-y: auto;
            max-width: 200px;
        }

        /* Rendre les éléments de la liste des utilisateurs transparents */
        #userList li {
            list-style: none;
            background-color: transparent;  /* Arrière-plan transparent */
            padding: 5px;
            margin-bottom: 5px;
            color: #000;  /* Couleur du texte */
        }

        #chatContainer {
            flex: 3;
            display: flex;
            flex-direction: column;
        }

        #chatWindow {
            flex-grow: 1;
            height: 400px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }

        #messageForm {
            display: flex;
        }

        #messageInput {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-right: 10px;
        }

        #messageForm button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #messageForm button:hover {
            background-color: #0056b3;
        }

        /* Amélioration du bouton pour envoyer un fichier */
        #fileLabel {
            display: inline-block;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }

        #fileLabel:hover {
            background-color: #0056b3;
        }

        #fileInput {
            display: none; /* Masquer le champ de fichier natif */
        }

        #logoutButton {
            padding: 10px 20px;
            background-color: red;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }

        #logoutButton:hover {
            background-color: darkred;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Liste des utilisateurs connectés à gauche -->
        <div id="usersContainer">
            <h3>Utilisateurs connectés :</h3>
            <ul id="userList"></ul>
        </div>

        <!-- Zone de chat à droite -->
        <div id="chatContainer">
            <div id="chatWindow"></div>
            <form id="messageForm">
                <input type="text" id="messageInput" placeholder="Tapez un message" required>
                <button type="submit">Envoyer</button>
            </form>
            <!-- Amélioration du bouton d'envoi de fichier -->
            <label id="fileLabel" for="fileInput">Choisir un fichier</label>
            <input type="file" id="fileInput">
            <button id="logoutButton">Déconnexion</button>
        </div>
    </div>
</body>
</html>
